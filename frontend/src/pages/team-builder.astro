---
import BaseLayout from "../layouts/BaseLayout.astro";
---
<BaseLayout title="Team Builder — PokéTeam">
  <section class="container" style="margin-top:1.5rem;">
    <h1>Create a Team</h1>

    <form id="team-form" class="form">
      <div class="input">
        <label for="teamName">Team name</label>
        <input id="teamName" placeholder="e.g. Elite Six" required />
      </div>

      <div class="card" style="background:#fff;margin-top:1rem;">
        <div class="input">
          <label for="pokeQuery">Add Pokémon by name or ID</label>
          <div style="display:flex;gap:.5rem;flex-wrap:wrap;">
            <input id="pokeQuery" placeholder="pikachu or 25" style="flex:1;min-width:200px" />
            <button type="button" id="addPoke" class="button">Add</button>
          </div>
        </div>
        <small style="opacity:.8;font-weight:700">Up to 6 members. Click a slot to remove.</small>

        <div id="slots" class="grid" style="margin-top:.75rem;grid-template-columns:repeat(auto-fill,minmax(140px,1fr))"></div>
      </div>

      <div style="display:flex;gap:.75rem;flex-wrap:wrap;margin-top:1rem;">
        <button type="submit" class="button">Save team</button>
        <a class="button secondary" href="/dashboard">Cancel</a>
      </div>
    </form>
  </section>

  <script type="module">
    import { API_BASE } from "../lib/api.js";

    const POKE_API = 'https://pokeapi.co/api/v2/pokemon';
    const form = document.getElementById('team-form');
    const nameEl = document.getElementById('teamName');
    const qEl = document.getElementById('pokeQuery');
    const addBtn = document.getElementById('addPoke');
    const slots = document.getElementById('slots');

    function readUser(){
      const raw = localStorage.getItem('poketeam:user');
      if (!raw) { window.location.replace('/login'); return null; }
      return JSON.parse(raw);
    }

    const members = [];

    function renderSlots(){
      slots.innerHTML = '';
      for (let i=0;i<6;i++){
        const m = members[i];
        const box = document.createElement('div');
        box.className = 'card';
        box.style.cssText = 'height:160px;background:#fff;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:.35rem;cursor:pointer;';
        if (m){
          const niceName = m.name[0].toUpperCase()+m.name.slice(1);
          const typeLabels = (m.types || []).map(t => t[0].toUpperCase()+t.slice(1));
          box.innerHTML = `
            <div class="badge">#${m.id}</div>
            <img src="${m.image || `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${m.id}.png`}" alt="${niceName}" style="max-height:80px;filter:drop-shadow(0 6px 12px rgba(0,0,0,.2))" loading="lazy"/>
            <strong>${niceName}</strong>
            ${typeLabels.length ? `<div style="display:flex;gap:.25rem;flex-wrap:wrap;justify-content:center;">
              ${typeLabels.map(t => `<span class="badge" style="font-size:.7rem;">${t}</span>`).join("")}
            </div>` : ""}
          `;
        } else {
          box.innerHTML = '<span style="opacity:.7;font-weight:800">Empty</span>';
        }
        box.addEventListener('click',()=>{
          if (m){
            const idx = members.findIndex(x=>x.id===m.id);
            if (idx>-1){ members.splice(idx,1); renderSlots(); }
          }
        });
        slots.append(box);
      }
    }

    async function findPokemon(q){
      if (!q) return null;
      const res = await fetch(`${POKE_API}/${q.toLowerCase()}`);
      if (!res.ok) return null;
      const p = await res.json();
      const types = Array.isArray(p.types) ? p.types.map(t => t.type?.name).filter(Boolean) : [];
      const image = p.sprites?.other?.['official-artwork']?.front_default || p.sprites?.front_default || null;
      return { id: p.id, name: p.name, types, image };
    }

    addBtn.addEventListener('click', async () => {
      if (members.length >= 6) { alert('Team is full (max 6).'); return; }
      const q = qEl.value.trim();
      if (!q) return;
      const p = await findPokemon(q);
      if (!p) { alert('Pokémon not found.'); return; }
      if (members.some(m=>m.id===p.id)) { alert('Already in team.'); return; }
      members.push(p);
      qEl.value = '';
      renderSlots();
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const user = readUser();
      if (!user) return;

      const name = nameEl.value.trim();
      if (!name) { alert('Please enter a team name.'); return; }
      if (!members.length) { alert('Add at least 1 Pokémon.'); return; }

      try {
        // 1) Create the team for this user
        const createRes = await fetch(`${API_BASE}/teams/create`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            user_id: user.id,
            team_name: name,
          }),
        });
        const createPayload = await createRes.json().catch(() => null);

        if (!createRes.ok || !createPayload || createPayload.success !== true || !createPayload.data) {
          const msg = createPayload?.error || 'Failed to create team.';
          alert(msg);
          return;
        }

        const team = createPayload.data;
        const teamId = team.id || team.team_id;
        if (!teamId) {
          alert('Team created but ID is missing in response.');
          return;
        }

        // 2) Add each Pokémon to the team via backend
        for (const m of members) {
          const res = await fetch(`${API_BASE}/teams/${teamId}/pokemon/${m.id}`, {
            method: 'POST',
          });
          const payload = await res.json().catch(() => null);
          if (!res.ok || !payload || payload.success !== true) {
            console.warn('Failed to add Pokémon to team:', m, payload);
          }
        }

        alert('Team saved successfully!');
        window.location.href = '/dashboard';
      } catch (err) {
        console.error('Failed to save team:', err);
        alert('Unable to save team. Please try again later.');
      }
    });

    // init
    if (readUser()) renderSlots();
  </script>
</BaseLayout>
